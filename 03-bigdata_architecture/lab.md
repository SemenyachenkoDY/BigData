# Лабораторная работа 3-1. Проектирование архитектуры хранилища больших данных

**Вариант 14:** Биотехнологическая компания: анализ геномных последовательностей (NGS), поиск паттернов в данных клинических исследований, моделирование лекарственного взаимодействия.  
Источники: данные секвенирования, данные клинических испытаний.


**Цель работы**

Разработать архитектуру хранилища больших данных для биотехнологической компании, обеспечивающую хранение, обработку и анализ больших объемов геномных и клинических данных.  
Система должна поддерживать сценарии:
- Анализ геномных последовательностей (NGS);
- Поиск паттернов и корреляций в данных клинических исследований;
- Моделирование лекарственного взаимодействия с использованием ML/AI.


## 1. Анализ требований

### 1.1. Объем данных

| Тип данных | Доля | Годовой объем | Характеристика |
|-------------|------|----------------|----------------|
| Данные NGS (сырые FASTQ/BAM файлы) | 60% | 400 ТБ – 1.5 ПБ | Неструктурированные бинарные данные |
| Клинические исследования (CSV, JSON, HL7) | 25% | 150 – 500 ТБ | Полуструктурированные данные |
| Молекулярные модели (3D-структуры, PDB, изображения) | 10% | 50 – 200 ТБ | Медиафайлы и изображения |
| Метаданные и результаты анализа | 5% | 25 – 100 ТБ | Структурированные таблицы (SQL) |

---

### 1.2. Скорость поступления данных

- Потоковые данные с лабораторных секвенаторов: 2–10 ГБ/час на устройство  
- Импорт клинических данных: 100–500 тыс. записей/день  
- Обновление моделей ML: еженедельно  
- Обновление базы лекарственных взаимодействий: ежедневно  

---

### 1.3. Типы данных

- Структурированные: результаты анализов, клинические таблицы, метаданные образцов  
- Полуструктурированные: JSON-данные API клинических центров, HL7-сообщения  
- Неструктурированные: геномные последовательности, микроскопические изображения, модели молекул  

---

### 1.4. Аналитика и обработка

- Анализ паттернов геномных данных (Spark + MLflow);
- Поиск биомаркеров (Flink streaming);
- Моделирование лекарственных взаимодействий (Python + TensorFlow);
- Аналитические панели для врачей и исследователей (Superset, Tableau);
- Оркестрация вычислений (Airflow).

---

### 1.5. Доступность и безопасность

| Параметр | Требование |
|-----------|-------------|
| SLA доступности | 99.9% |
| Время отклика аналитических запросов | ≤ 20 сек |
| RTO | ≤ 4 ч |
| RPO | ≤ 30 мин |
| Шифрование данных | AES-256, TLS 1.3 |
| Соответствие | 152-ФЗ, GDPR (для международных данных) |

---

## 2. Архитектура хранилища больших данных

### 2.1. Компоненты архитектуры

#### Источники данных
- Лабораторные секвенаторы (NGS: Illumina, Oxford Nanopore)
- Электронные медицинские карты (EMR)
- Системы клинических испытаний (LIMS, EDC)
- Внешние базы данных лекарственных взаимодействий (DrugBank, PubChem)

#### Слой сбора данных
- Apache Kafka — потоковая шина для событий от секвенаторов и лабораторий  
- Logstash — сбор и предобработка логов и файлов  
- Orthanc — обработка DICOM/медицинских изображений  

#### Слой хранения данных
- MinIO — объектное хранилище (сырые файлы FASTQ, BAM, DICOM)  
- PostgreSQL — метаданные образцов и результатов  
- ClickHouse — аналитические запросы по большим объемам данных  
- Delta Lake (на MinIO) — табличные данные для аналитики  

#### Слой обработки и анализа
- Apache Spark — ETL и пакетная аналитика  
- Apache Flink — потоковая обработка (поступающие данные секвенирования)  
- MLflow — управление экспериментами ML  

#### Слой машинного обучения
- TensorFlow / PyTorch — моделирование лекарственных взаимодействий  
- Jupyter Notebooks — исследовательская аналитика  
- Apache Superset / Tableau — визуализация данных  

#### Слой оркестрации и мониторинга
- Apache Airflow — планирование рабочих процессов  
- Prometheus + Grafana — мониторинг производительности и SLA  
- ELK Stack (Elasticsearch, Logstash, Kibana) — анализ логов  

#### Слой управления данными
- OpenMetadata — каталог данных, lineage и контроль качества  

---

## 3. Схема архитектуры
![](files/architecture.png)

## 4. Процесс обработки данных

1. Данные секвенирования (FASTQ/BAM) поступают в Kafka через коннекторы с лабораторных систем.  
2. Orthanc принимает DICOM и микроскопические изображения.  
3. Logstash парсит клинические JSON/CSV файлы и публикует в Kafka.  
4. Apache Airflow управляет процессом загрузки данных в MinIO и последующей обработкой.  
5. Spark обрабатывает данные партиями, создавая агрегаты и таблицы Delta Lake.  
6. Flink анализирует потоки данных для обнаружения паттернов в реальном времени.  
7. MLflow управляет обучением моделей на TensorFlow (поиск биомаркеров, моделирование взаимодействий).  
8. ClickHouse обеспечивает быструю аналитическую агрегацию данных.  
9. Superset визуализирует результаты для исследователей и врачей.  
10. Grafana и Prometheus отслеживают состояние всех сервисов.  

---

## 5. Масштабирование и отказоустойчивость

- Кластеры Kafka, Flink и Spark масштабируются горизонтально.  
- MinIO развернут в распределённом режиме (erasure coding, replication).  
- PostgreSQL и ClickHouse работают с репликацией и failover.  
- Airflow запускается в HA-конфигурации.  
- Prometheus с горячими standby-серверами.  

---

## 6. Безопасность данных

- TLS 1.3 и взаимная аутентификация сервисов.  
- AES-256 шифрование данных в покое.  
- Управление ключами через HashiCorp Vault.  
- Ролевая модель доступа (RBAC) и аудит.  
- Анонимизация и псевдонимизация геномных данных.  
- Мониторинг событий безопасности (SIEM).  

---

## 7. Расчет стоимости внедрения и поддержки (на 1 год)

| Компонент | Кол-во узлов | Стоимость узла/мес (₽) | Годовая стоимость (₽) |
|------------|----------------|--------------------------|------------------------|
| MinIO (8 серверов, 1 ПБ) | 8 | 45,000 | 4,320,000 |
| PostgreSQL Cluster | 3 | 35,000 | 1,260,000 |
| ClickHouse Cluster | 4 | 40,000 | 1,920,000 |
| Kafka + Flink | 6 | 50,000 | 3,600,000 |
| Spark Cluster | 5 | 55,000 | 3,300,000 |
| Airflow + MLflow | 2 | 30,000 | 720,000 |
| Superset + Grafana + Prometheus | 2 | 25,000 | 600,000 |
| DevOps и поддержка (2 специалиста) | — | — | 3,000,000 |
| ИТОГО | — | — | 18,720,000 ₽ / год |

---

## 8. Анализ возможных проблем и решений

| Проблема | Риск | Решение |
|-----------|------|----------|
| Большие файлы NGS перегружают хранилище | Рост затрат на хранение | Политики жизненного цикла (S3 lifecycle), архивация в «холодные» слои |
| Медленные аналитические запросы | Высокие задержки в ClickHouse | Индексация по биомаркерам, шардирование |
| Конфликт версий данных между системами | Нарушение целостности | Идемпотентные ETL-процессы, контроль версий Delta Lake |
| Рост нагрузки на Airflow | Замедление DAG-процессов | Горизонтальное масштабирование и CeleryExecutor |
| Чувствительные данные | Нарушение 152-ФЗ | Полная анонимизация и контроль доступа RBAC |


## Выводы

Разработанная архитектура обеспечивает:
- Обработку и анализ больших объемов геномных и клинических данных;  
- Поддержку высокопроизводительных ML/AI-вычислений;  
- Безопасность и масштабируемость инфраструктуры;  
- Централизованный контроль данных и метаданных.  

Архитектура подходит для компаний, занимающихся биоинформатикой, клиническими исследованиями и разработкой лекарств.  
Она оптимизирована под российские реалии и ориентирована на использование открытого ПО с минимальными затратами на лицензирование.
